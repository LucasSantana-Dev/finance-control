# Test Database Configuration - Override environment variables
#
# NOTE: This H2 configuration is used for unit tests that use @DataJpaTest
# Integration tests that extend BaseIntegrationTest use TestContainers PostgreSQL
# TestContainers properties are set dynamically via @DynamicPropertySource in BaseIntegrationTest
# and will override these H2 settings for integration tests.
#
# H2 compatibility: Create JSONB domain and configure PostgreSQL compatibility mode
# The JSONB domain allows H2 to recognize JSONB type and map it to TEXT
app.database.url=jdbc:h2:mem:testdb;MODE=PostgreSQL;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE;INIT=CREATE DOMAIN IF NOT EXISTS JSONB AS TEXT
app.database.port=
app.database.name=testdb
app.database.username=sa
app.database.password=
app.database.driver-class-name=org.h2.Driver

# Override environment variables for tests (used by H2 unit tests)
# Integration tests using TestContainers will override these via @DynamicPropertySource
DB_USERNAME=sa
DB_PASSWORD=
DB_URL=jdbc:h2:mem:testdb;MODE=PostgreSQL;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE;INIT=CREATE DOMAIN IF NOT EXISTS JSONB AS TEXT
POSTGRES_DB=testdb

# Test Database Connection Pool Configuration
app.database.pool.initial-size=2
app.database.pool.max-size=5
app.database.pool.min-idle=1
app.database.pool.max-lifetime=300000
app.database.pool.connection-timeout=10000
app.database.pool.idle-timeout=300000
app.database.pool.leak-detection-threshold=60000

# Test JPA Configuration
app.jpa.hibernate-ddl-auto=create-drop
app.jpa.dialect=org.hibernate.dialect.H2Dialect
app.jpa.show-sql=false
app.jpa.format-sql=false
app.jpa.use-sql-comments=false
app.jpa.defer-datasource-initialization=false

# Test JPA Properties
app.jpa.properties.hibernate-format-sql=false
app.jpa.properties.hibernate-use-sql-comments=false
app.jpa.properties.hibernate-jdbc-batch-size=10
app.jpa.properties.hibernate-order-inserts=true
app.jpa.properties.hibernate-order-updates=true
app.jpa.properties.hibernate-batch-versioned-data=true
app.jpa.properties.hibernate-jdbc-fetch-size=10
app.jpa.properties.hibernate-default-batch-fetch-size=8

# Test JWT Configuration
app.security.jwt.secret=mySecretKeyThatIsAtLeast256BitsLongForTestingPurposesOnly123456789012345678901234567890
app.security.jwt.expiration-ms=86400000
app.security.jwt.refresh-expiration-ms=604800000
app.security.jwt.issuer=finance-control
app.security.jwt.audience=finance-control-users

# Test Redis Configuration - Disabled for tests
# Explicitly unset Redis host to prevent RedisConfig from loading
app.redis.host=
app.redis.port=6379
app.redis.password=
app.redis.database=0
app.redis.timeout=2000

# Test Security Configuration (additional test settings)
app.security.jwt.secret=testSecretKeyForTestingOnly
app.security.jwt.expiration-ms=3600000
app.security.jwt.refresh-expiration-ms=7200000
app.security.jwt.issuer=finance-control-test
app.security.jwt.audience=finance-control-test-users
app.security.public-endpoints=/api/auth/**,/api/users,/api/monitoring/**,/monitoring/**,/actuator/**,/swagger-ui/**,/v3/api-docs/**

# Test CORS Configuration
app.security.cors.allowed-origins=http://localhost:3000,http://localhost:8080
app.security.cors.allowed-methods=GET,POST,PUT,DELETE,OPTIONS
app.security.cors.allowed-headers=*
app.security.cors.allow-credentials=true
app.security.cors.max-age=3600

# Test Server Configuration
app.server.port=0
app.server.context-path=
app.server.servlet-path=/
app.server.max-http-header-size=8192
app.server.max-http-post-size=2097152
app.server.connection-timeout=10000
app.server.read-timeout=15000
app.server.write-timeout=15000

# Test Logging Configuration
app.logging.level=DEBUG
app.logging.pattern=%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n
app.logging.file-path=logs
app.logging.file-name=finance-control-test.log
app.logging.error-file-name=finance-control-test-error.log
app.logging.max-file-size=5242880
app.logging.max-history=7
app.logging.queue-size=256
app.logging.async=false

# Test Flyway Configuration
app.flyway.enabled=false
app.flyway.locations=classpath:db/migration
app.flyway.baseline-on-migrate=false
app.flyway.baseline-version=0
app.flyway.validate-on-migrate=false
app.flyway.out-of-order=false
app.flyway.clean-disabled=true
app.flyway.clean-on-validation-error=false

# Test Actuator Configuration
app.actuator.enabled=false
app.actuator.endpoints=health
app.actuator.base-path=/actuator
app.actuator.expose-health-details=false
app.actuator.show-details=false
app.actuator.show-components=false

# Test OpenAPI Configuration
app.open-api.title=Finance Control API - Test
app.open-api.description=API for managing personal finances - Test Environment
app.open-api.version=1.0.0-test
app.open-api.contact-name=Finance Control Team
app.open-api.contact-email=test@finance-control.com
app.open-api.contact-url=https://github.com/LucasSantana/finance-control
app.open-api.license-name=MIT License
app.open-api.license-url=https://opensource.org/licenses/MIT
app.open-api.server-url=http://localhost:0
app.open-api.server-description=Test server

# Test Pagination Configuration
app.pagination.default-page-size=5
app.pagination.max-page-size=20
app.pagination.default-sort=id
app.pagination.default-direction=ASC

# Legacy Spring Boot Properties (for backward compatibility)
spring.datasource.url=${app.database.url}
spring.datasource.username=${app.database.username}
spring.datasource.password=${app.database.password}
spring.datasource.driver-class-name=${app.database.driver-class-name}

# Disable external services for tests
spring.autoconfigure.exclude=org.springframework.boot.autoconfigure.data.redis.RedisAutoConfiguration,org.springframework.boot.autoconfigure.http.client.HttpClientAutoConfiguration,org.springframework.boot.autoconfigure.web.client.RestClientAutoConfiguration
spring.test.context.bean.override.exclude=com.finance_control.shared.config.RedisConfig

# Disable caching in tests (no Redis needed)
spring.cache.type=none

# Disable Supabase for tests
app.supabase.enabled=false
app.supabase.database.enabled=false
app.supabase.storage.enabled=false
app.supabase.realtime.enabled=false
SUPABASE_ENABLED=false
SUPABASE_DATABASE_ENABLED=false
SUPABASE_STORAGE_ENABLED=false
SUPABASE_REALTIME_ENABLED=false

# Disable frontend error monitoring for tests (to avoid ObjectMapper dependency in @DataJpaTest)
app.monitoring.frontendErrors.enabled=false

spring.jpa.hibernate.ddl-auto=${app.jpa.hibernate-ddl-auto}
spring.jpa.properties.hibernate.dialect=${app.jpa.dialect}
spring.jpa.show-sql=${app.jpa.show-sql}
spring.jpa.properties.hibernate.format_sql=${app.jpa.properties.hibernate-format-sql}
spring.jpa.properties.hibernate.use_sql_comments=${app.jpa.properties.hibernate-use-sql-comments}
spring.jpa.defer-datasource-initialization=${app.jpa.defer-datasource-initialization}

logging.level.root=${app.logging.level}
logging.level.com.finance_control=DEBUG
logging.level.org.springframework.security=DEBUG

spring.flyway.enabled=${app.flyway.enabled}
spring.flyway.locations=${app.flyway.locations}

spring.data.web.pageable.default-page-size=${app.pagination.default-page-size}
spring.data.web.pageable.max-page-size=${app.pagination.max-page-size}

server.port=${app.server.port}
server.servlet.context-path=${app.server.context-path}

management.endpoints.web.exposure.include=${app.actuator.endpoints}
management.endpoint.health.show-details=NEVER
management.endpoints.web.base-path=${app.actuator.base-path}

# JWT Configuration (legacy)
jwt.secret=${app.security.jwt.secret}
jwt.expiration=${app.security.jwt.expiration-ms}

# Security Configuration for tests
management.security.enabled=false

# Redis Configuration for tests - Disabled
# spring.data.redis.host=${app.redis.host}
# spring.data.redis.port=${app.redis.port}
# spring.data.redis.password=${app.redis.password}
# spring.data.redis.database=${app.redis.database}
# spring.data.redis.timeout=${app.redis.timeout}
# spring.data.redis.jedis.pool.max-active=${app.redis.jedis.pool.max-active}
# spring.data.redis.jedis.pool.max-idle=${app.redis.jedis.pool.max-idle}
# spring.data.redis.jedis.pool.min-idle=${app.redis.jedis.pool.min-idle}
# spring.data.redis.jedis.pool.max-wait=${app.redis.jedis.pool.max-wait}
